<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <title>CLB Pickleball - Qu·∫£n l√Ω sinh ho·∫°t</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

  <style>
    body {
      background: linear-gradient(180deg, #eaf3ff 0%, #f8fbff 100%);
      font-family: "Segoe UI", Arial, sans-serif;
      color: #003366;
    }

    h1 {
      color: #004a99;
    }

    .session-card {
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
      padding: 1rem;
      transition: 0.2s ease;
      height: 100%;
    }

    .session-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
    }

    .session-title {
      font-size: 1.1rem;
      color: #004a99;
      font-weight: 600;
      margin-bottom: 0;
    }

    .session-date {
      font-size: 0.85rem;
      color: #777;
    }

    .btn-delete,
    .btn-small-del {
      border: none;
      background: transparent;
      color: #dc3545;
      font-size: 1rem;
      cursor: pointer;
      transition: 0.2s;
    }

    .btn-delete:hover,
    .btn-small-del:hover {
      color: #a71d2a;
    }

    .add-fee {
      display: flex;
      gap: 6px;
      margin-top: 8px;
      flex-wrap: nowrap;
      align-items: center;
    }

    .add-fee input,
    .add-fee select {
      flex: 1 1 auto;
    }

    .add-fee button {
      white-space: nowrap;
      flex-shrink: 0;
    }

    table {
      font-size: 0.9rem;
    }

    #summary {
      border-top: 3px solid #004a99;
    }

    .add-fee .form-control {
      max-width: 45%;
    }

    table.table-sm th,
    table.table-sm td {
      padding: 0.25rem 0.5rem;
      /* gi·∫£m padding tr√™n/d∆∞·ªõi */
      font-size: 0.85rem;
      /* nh·ªè font h∆°n ch√∫t n·∫øu mu·ªën */
      line-height: 1.2;
      /* kho·∫£ng c√°ch d√≤ng */
    }
  </style>
</head>

<body>
  <div class="container-fluid py-4">
    <h1 class="text-center fw-bold mb-4">Qu·∫£n l√Ω sinh ho·∫°t CLB VAF Pickleball</h1>

    <!-- Thanh c√¥ng c·ª• -->
    <div class="d-flex justify-content-end align-items-center mb-4 gap-2 flex-wrap">
      <span id="user-info" class="fw-semibold text-primary"></span>
      <button id="login-btn" class="btn btn-primary btn-sm" onclick="login()">ƒêƒÉng nh·∫≠p Google</button>
      <button id="logout-btn" class="btn btn-danger btn-sm d-none" onclick="logout()">ƒêƒÉng xu·∫•t</button>
    </div>

    <!-- Khu v·ª±c th√™m th√†nh vi√™n v√† t·∫°o bu·ªïi -->
    <div id="admin-section" class="text-center mb-4 d-none">

      <!-- Th√™m th√†nh vi√™n -->
      <div
        class="bg-white shadow-sm rounded p-3 d-inline-flex align-items-center gap-2 flex-wrap justify-content-center border border-success-subtle mb-2">
        <input type="text" id="newMemberName" class="form-control form-control-sm w-auto"
          placeholder="T√™n th√†nh vi√™n" />
        <button class="btn btn-outline-primary btn-sm" onclick="addMember()">‚ûï Th√™m th√†nh vi√™n</button>
      </div>

      <!-- Th√™m bu·ªïi -->
      <div
        class="bg-white shadow-sm rounded p-3 d-inline-flex align-items-center gap-2 flex-wrap justify-content-center border border-primary-subtle">
        <input type="text" id="newName" class="form-control form-control-sm w-auto"
          placeholder="T√™n bu·ªïi (VD: CN s√°ng)" />
        <input type="date" id="newDate" class="form-control form-control-sm w-auto" />
        <button class="btn btn-outline-primary btn-sm" onclick="addSession()">‚ûï T·∫°o bu·ªïi</button>
      </div>
    </div>

    <!-- Danh s√°ch bu·ªïi -->
    <div id="sessions" class="row row-cols-1 row-cols-md-3 row-cols-lg-3 g-3" style="min-height: 200px;">
      <!-- JS render v√†o ƒë√¢y -->
    </div>

    <!-- T·ªïng k·∫øt -->
    <div id="summary" class="bg-white shadow-sm rounded p-3 mt-4">
      <h4 class="text-primary mb-3 fw-semibold">üí∞ T·ªïng ti·ªÅn t·ª´ng th√†nh vi√™n</h4>
      <div class="table-responsive">
        <table class="table table-bordered table-hover table-sm align-middle text-center mb-0">
          <thead class="table-primary">
            <tr>
              <th>Th√†nh vi√™n</th>
              <th>T·ªïng</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Bootstrap Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Firebase + Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, getDocs, addDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCnUJ4PUw8f4usZdBmuSuhCH8GvR0PdD5Y",
      authDomain: "pickleball-fee-tracker.firebaseapp.com",
      projectId: "pickleball-fee-tracker",
      storageBucket: "pickleball-fee-tracker.firebasestorage.app",
      messagingSenderId: "874940793189",
      appId: "1:874940793189:web:2a003b4c5ea7f07bcb618c"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();
    const ADMIN_UID = "w9vbMAKIlfWDPWkYVKMHEyRq8wF3";

    let currentUser = null;
    let isLoading = false;
    let memberNames = new Set();

    const formatVND = n => Number(n).toLocaleString("vi-VN") + "ƒë";

    // üîÅ Load d·ªØ li·ªáu
    async function loadData() {
      if (isLoading) return;
      isLoading = true;

      const sessionsDiv = document.getElementById("sessions");
      const summaryBody = document.querySelector("#summary tbody");
      sessionsDiv.innerHTML = "";
      summaryBody.innerHTML = "";

      const totals = {};
      memberNames.clear();

      // L·∫•y danh s√°ch t√™n th√†nh vi√™n t·ª´ collection 'members'
      const memberSnap = await getDocs(collection(db, "members"));
      memberSnap.forEach(doc => {
        const data = doc.data();
        if (data.ten) memberNames.add(data.ten);
      });

      const sessionSnap = await getDocs(collection(db, "sessions"));
      const sessions = [];
      sessionSnap.forEach(docSnap => sessions.push({ id: docSnap.id, ...docSnap.data() }));
      sessions.sort((a, b) => (b.ngay || "").localeCompare(a.ngay || ""));

      for (const s of sessions) {
        const feesSnap = await getDocs(collection(db, "sessions", s.id, "fees"));
        const col = document.createElement("div");
        col.className = "col-12 col-md-6 col-lg-4 col-xl-2";
        const isAdmin = currentUser && currentUser.uid === ADMIN_UID;

        let feesHTML = "";
        feesSnap.forEach(f => {
          const data = f.data();
          if (!data.ten || !data.tongtien || !memberNames.has(data.ten)) return;

          feesHTML += `
            <tr>
              <td>${data.ten}</td>
              <td>${formatVND(data.tongtien)}</td>
              ${isAdmin ? `<td><button class="btn-small-del" onclick="deleteFee('${s.id}', '${f.id}')">‚úñ</button></td>` : ""}
            </tr>`;
          totals[data.ten] = (totals[data.ten] || 0) + Number(data.tongtien);
        });
        const formattedDate = s.ngay
          ? new Date(s.ngay).toLocaleDateString("vi-VN")
          : "";
        col.innerHTML = `
          <div class="session-card h-100 d-flex flex-column">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <div>
                <h5 class="session-title">${s.ghichu || "Kh√¥ng t√™n"}</h5>
                <small class="session-date">${formattedDate || ""}</small>
              </div>
              ${isAdmin ? `<button class="btn-delete" onclick="deleteSession('${s.id}')">‚úñ</button>` : ""}
            </div>

            <div class="table-responsive mb-2 flex-grow-1">
              <table class="table table-sm table-bordered align-middle text-center mb-0">
                <thead class="table-light">
                  <tr><th>Th√†nh vi√™n</th><th>S·ªë ti·ªÅn</th>${isAdmin ? "<th></th>" : ""}</tr>
                </thead>
                <tbody>${feesHTML}</tbody>
              </table>
            </div>

            ${isAdmin ? `
            <div class="add-fee" id="fee-form-${s.id}">
              <select id="name-${s.id}" class="form-control form-control-sm">
                <option value="">-- Ch·ªçn--</option>
                ${[...memberNames].map(name => `<option value="${name}">${name}</option>`).join('')}
              </select>
              <input type="number" placeholder="S·ªë ti·ªÅn" id="amount-${s.id}" class="form-control form-control-sm" />
              <button class="btn btn-sm" onclick="addFee('${s.id}')">‚ûï</button>
            </div>` : ""}
          </div>
        `;
        sessionsDiv.appendChild(col);
      }

      Object.entries(totals).forEach(([name, total]) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${name}</td><td>${formatVND(total)}</td>`;
        summaryBody.appendChild(tr);
      });

      isLoading = false;
    }

    // ‚ûï Th√™m th√†nh vi√™n
    window.addMember = async () => {
      const name = document.getElementById("newMemberName").value.trim();
      if (!name) return alert("Nh·∫≠p t√™n th√†nh vi√™n!");
      try {
        await addDoc(collection(db, "members"), { ten: name });
        document.getElementById("newMemberName").value = "";
        await loadData();
      } catch (err) {
        alert("L·ªói th√™m th√†nh vi√™n: " + err.message);
      }
    };

    // ‚ûï Th√™m fee
    window.addFee = async id => {
      const name = document.getElementById(`name-${id}`).value.trim();
      const amount = Number(document.getElementById(`amount-${id}`).value);
      if (!name || isNaN(amount)) return alert("Ch·ªçn t√™n v√† nh·∫≠p s·ªë ti·ªÅn h·ª£p l·ªá!");
      if (!memberNames.has(name)) return alert("T√™n ch∆∞a t·ªìn t·∫°i trong danh s√°ch th√†nh vi√™n!");
      await addDoc(collection(db, "sessions", id, "fees"), { ten: name, tongtien: amount });
      await loadData();
    };

    // ‚ûï T·∫°o bu·ªïi
    window.addSession = async () => {
      const ghichu = document.getElementById("newName").value.trim();
      const ngay = document.getElementById("newDate").value.trim();
      if (!ghichu || !ngay) return alert("Nh·∫≠p ƒë·ªß th√¥ng tin!");
      await addDoc(collection(db, "sessions"), { ghichu, ngay });
      document.getElementById("newName").value = "";
      document.getElementById("newDate").value = "";
      await loadData();
    };

    // ‚ùå X√≥a bu·ªïi
    window.deleteSession = async id => {
      if (!confirm("X√≥a bu·ªïi n√†y?")) return;
      const feesSnap = await getDocs(collection(db, "sessions", id, "fees"));
      for (const f of feesSnap.docs) await deleteDoc(doc(db, "sessions", id, "fees", f.id));
      await deleteDoc(doc(db, "sessions", id));
      await loadData();
    };

    // ‚ùå X√≥a fee
    window.deleteFee = async (sessionId, feeId) => {
      if (!confirm("X√≥a ng∆∞·ªùi n√†y?")) return;
      await deleteDoc(doc(db, "sessions", sessionId, "fees", feeId));
      await loadData();
    };

    // üë§ Login
    window.login = async () => {
      try { await signInWithPopup(auth, provider); }
      catch (err) { alert("L·ªói ƒëƒÉng nh·∫≠p: " + err.message); }
    };
    window.logout = async () => signOut(auth);

    // üîÑ Theo d√µi ƒëƒÉng nh·∫≠p
    onAuthStateChanged(auth, user => {
      const admin = document.getElementById("admin-section");
      const loginBtn = document.getElementById("login-btn");
      const logoutBtn = document.getElementById("logout-btn");
      const userInfo = document.getElementById("user-info");
      currentUser = user || null;

      if (user) {
        userInfo.textContent = `üëã ${user.displayName}`;
        loginBtn.classList.add("d-none");
        logoutBtn.classList.remove("d-none");
        admin.classList.toggle("d-none", user.uid !== ADMIN_UID);
      } else {
        userInfo.textContent = "";
        loginBtn.classList.remove("d-none");
        logoutBtn.classList.add("d-none");
        admin.classList.add("d-none");
      }
      loadData();
    });
  </script>
</body>

</html>