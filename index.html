<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <title>CLB Pickleball - Qu·∫£n l√Ω sinh ho·∫°t</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

  <style>
    body {
      background: linear-gradient(180deg, #eaf3ff 0%, #f8fbff 100%);
      font-family: "Segoe UI", Arial, sans-serif;
      color: #003366;
    }

    h1 {
      color: #004a99;
    }

    .session-card {
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
      padding: 1rem;
      transition: 0.2s ease;
      height: 100%;
    }

    .session-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
    }

    .session-title {
      font-size: 1.1rem;
      color: #004a99;
      font-weight: 600;
      margin-bottom: 0;
    }

    .session-date {
      font-size: 0.85rem;
      color: #777;
    }

    .btn-delete,
    .btn-small-del {
      border: none;
      background: transparent;
      color: #dc3545;
      font-size: 1rem;
      cursor: pointer;
      transition: 0.2s;
    }

    .btn-delete:hover,
    .btn-small-del:hover {
      color: #a71d2a;
    }

    table.table-sm th,
    table.table-sm td {
      padding: 0.25rem 0.5rem;
      font-size: 0.85rem;
      line-height: 1.2;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.4);
      justify-content: center;
      align-items: center;
      z-index: 999;
    }

    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 450px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }
  </style>
</head>

<body>
  <div class="container-fluid py-4">
    <h1 class="text-center fw-bold mb-4">Qu·∫£n l√Ω sinh ho·∫°t CLB VAF Pickleball</h1>

    <!-- Thanh c√¥ng c·ª• -->
    <div class="d-flex justify-content-end align-items-center mb-4 gap-2 flex-wrap">
      <span id="user-info" class="fw-semibold text-primary"></span>
      <button id="login-btn" class="btn btn-primary btn-sm" onclick="login()">ƒêƒÉng nh·∫≠p Google</button>
      <button id="logout-btn" class="btn btn-danger btn-sm d-none" onclick="logout()">ƒêƒÉng xu·∫•t</button>
    </div>

    <!-- Khu v·ª±c Admin -->
    <div id="admin-section" class="text-center mb-4 d-none">
      <!-- Th√™m th√†nh vi√™n -->
      <div
        class="bg-white shadow-sm rounded p-3 d-inline-flex align-items-center gap-2 flex-wrap justify-content-center border border-success-subtle mb-2">
        <input type="text" id="newMemberName" class="form-control form-control-sm w-auto"
          placeholder="T√™n th√†nh vi√™n" />
        <button class="btn btn-outline-primary btn-sm" onclick="addMember()">‚ûï Th√™m th√†nh vi√™n</button>
      </div>

      <!-- Th√™m bu·ªïi -->
      <div
        class="bg-white shadow-sm rounded p-3 d-inline-flex align-items-center gap-2 flex-wrap justify-content-center border border-primary-subtle">
        <input type="text" id="newName" class="form-control form-control-sm w-auto"
          placeholder="T√™n bu·ªïi (VD: CN s√°ng)" />
        <input type="date" id="newDate" class="form-control form-control-sm w-auto" />
        <button class="btn btn-outline-primary btn-sm" onclick="addSession()">‚ûï T·∫°o bu·ªïi</button>
      </div>
    </div>

    <!-- Danh s√°ch bu·ªïi -->
    <div id="sessions" class="row row-cols-1 row-cols-md-3 row-cols-lg-3 g-3" style="min-height: 200px;"></div>

    <!-- T·ªïng k·∫øt -->
    <div id="summary" class="bg-white shadow-sm rounded p-3 mt-4">
      <h4 class="text-primary mb-3 fw-semibold">üí∞ T·ªïng ti·ªÅn t·ª´ng th√†nh vi√™n</h4>
      <div class="table-responsive">
        <table class="table table-bordered table-hover table-sm align-middle text-center mb-0">
          <thead class="table-primary">
            <tr>
              <th>Th√†nh vi√™n</th>
              <th>T·ªïng</th>
              <th>#</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Firebase Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, getDocs, addDoc, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCnUJ4PUw8f4usZdBmuSuhCH8GvR0PdD5Y",
      authDomain: "pickleball-fee-tracker.firebaseapp.com",
      projectId: "pickleball-fee-tracker",
      storageBucket: "pickleball-fee-tracker.firebasestorage.app",
      messagingSenderId: "874940793189",
      appId: "1:874940793189:web:2a003b4c5ea7f07bcb618c"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    const ADMIN_UID = "w9vbMAKIlfWDPWkYVKMHEyRq8wF3";
    let currentUser = null;
    let isLoading = false;
    let memberNames = new Set();

    const formatVND = n => Number(n).toLocaleString("vi-VN") + "ƒë";

    /* ------------------ Load d·ªØ li·ªáu ch√≠nh ------------------ */
    async function loadData() {
      if (isLoading) return;
      isLoading = true;

      const sessionsDiv = document.getElementById("sessions");
      const summaryBody = document.querySelector("#summary tbody");
      sessionsDiv.innerHTML = "";
      summaryBody.innerHTML = "";
      const totals = {};
      memberNames.clear();

      const memberSnap = await getDocs(collection(db, "members"));
      memberSnap.forEach(doc => {
        const d = doc.data();
        if (d.ten) memberNames.add(d.ten);
      });

      const sessionSnap = await getDocs(collection(db, "sessions"));
      const sessions = [];
      sessionSnap.forEach(s => sessions.push({ id: s.id, ...s.data() }));
      sessions.sort((a, b) => (b.ngay || "").localeCompare(a.ngay || "")); // m·ªõi nh·∫•t l√™n ƒë·∫ßu

      for (const s of sessions) {
        const feesSnap = await getDocs(collection(db, "sessions", s.id, "fees"));
        const unpaid = feesSnap.docs.filter(f => !f.data().isThanhToan);

        const col = document.createElement("div");
        col.className = "col-12 col-md-6 col-lg-4 col-xl-2";

        let rows = "";
        unpaid.forEach(f => {
          const d = f.data();
          if (!d.ten || !memberNames.has(d.ten)) return;
          totals[d.ten] = (totals[d.ten] || 0) + Number(d.tongtien);
          rows += `
            <tr>
              <td>${d.ten}</td>
              <td>${formatVND(d.tongtien)}</td>
              ${currentUser?.uid === ADMIN_UID ? `<td><button class="btn-small-del" onclick="deleteFee('${s.id}', '${f.id}')">‚úñ</button></td>` : ""}
            </tr>`;
        });

        const dateFmt = formatDateDDMMYYYY(s.ngay);
        col.innerHTML = `
        <div class="session-card h-100">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <div>
              <h5 class="session-title">${s.ghichu || "Kh√¥ng t√™n"}</h5>
              <small class="session-date">${dateFmt}</small>
            </div>
            ${currentUser?.uid === ADMIN_UID ? `<button class="btn-delete" onclick="deleteSession('${s.id}')">‚úñ</button>` : ""}
          </div>

          <table class="table table-sm table-bordered text-center mb-2">
            <thead class="table-light"><tr><th>Th√†nh vi√™n</th><th>S·ªë ti·ªÅn</th>${currentUser?.uid === ADMIN_UID ? "<th></th>" : ""}</tr></thead>
            <tbody>${rows}</tbody>
          </table>

          ${currentUser?.uid === ADMIN_UID ? `
          <div class="d-flex gap-1">
            <select id="name-${s.id}" class="form-control form-control-sm">
              <option value="">-- Ch·ªçn --</option>
              ${[...memberNames].map(n => `<option value="${n}">${n}</option>`).join("")}
            </select>
            <input type="number" id="amount-${s.id}" class="form-control form-control-sm" placeholder="S·ªë ti·ªÅn">
            <button class="btn btn-sm" onclick="addFee('${s.id}')">‚ûï</button>
          </div>` : ""}
        </div>`;
        sessionsDiv.appendChild(col);
      }
let grandTotal = 0;
      Object.entries(totals).sort((a, b) => b[1] - a[1]).forEach(([name, total]) => {
        grandTotal += total;
         const tr = document.createElement("tr");

    // N√∫t t·∫•t to√°n ch·ªâ admin
    const tatToanBtn = currentUser && currentUser.uid === ADMIN_UID
      ? `<button class="btn btn-sm btn-outline-primary" onclick="tatToan('${name}')">T·∫•t to√°n</button>`
      : "";

    // N√∫t l·ªãch s·ª≠ ai c≈©ng xem ƒë∆∞·ª£c
    const lichSuBtn = `<button class="btn btn-sm btn-outline-secondary" onclick="xemLichSu('${name}')">L·ªãch s·ª≠</button>`;

    tr.innerHTML = `
      <td>${name}</td>
      <td>${formatVND(total)}</td>
      <td>${tatToanBtn} ${lichSuBtn}</td>
    `;
    summaryBody.appendChild(tr);
      });

      if (grandTotal > 0) {
  const tr = document.createElement("tr");
  tr.style.fontWeight = "bold";
  tr.style.background = "#f0f7ff";
  tr.innerHTML = `
    <td>T·ªïng t·∫•t c·∫£</td>
    <td>${formatVND(grandTotal)}</td>
    <td></td>
  `;
  summaryBody.appendChild(tr);
      }
      isLoading = false;
    }

    /* ------------------ CRUD ------------------ */
    window.addMember = async () => {
      const name = document.getElementById("newMemberName").value.trim();
      if (!name) return alert("Nh·∫≠p t√™n!");
      await addDoc(collection(db, "members"), { ten: name });
      document.getElementById("newMemberName").value = "";
      loadData();
    };

    window.addFee = async id => {
      const name = document.getElementById(`name-${id}`).value.trim();
      const amount = Number(document.getElementById(`amount-${id}`).value);
      if (!name || isNaN(amount)) return alert("Ch·ªçn t√™n v√† nh·∫≠p ti·ªÅn!");
      await addDoc(collection(db, "sessions", id, "fees"), { ten: name, tongtien: amount, isThanhToan: false });
      loadData();
    };

    window.addSession = async () => {
      const ghichu = document.getElementById("newName").value.trim();
      const ngay = document.getElementById("newDate").value.trim();
      if (!ghichu || !ngay) return alert("Nh·∫≠p ƒë·ªß!");
      await addDoc(collection(db, "sessions"), { ghichu, ngay });
      document.getElementById("newName").value = "";
      document.getElementById("newDate").value = "";
      loadData();
    };

    window.deleteSession = async id => {
      if (!confirm("X√≥a bu·ªïi n√†y?")) return;
      const fees = await getDocs(collection(db, "sessions", id, "fees"));
      for (const f of fees.docs) await deleteDoc(doc(db, "sessions", id, "fees", f.id));
      await deleteDoc(doc(db, "sessions", id));
      loadData();
    };

    window.deleteFee = async (id, fid) => {
      if (!confirm("X√≥a ng∆∞·ªùi n√†y?")) return;
      await deleteDoc(doc(db, "sessions", id, "fees", fid));
      loadData();
    };

    window.tatToan = async name => {
      if (!confirm(`T·∫•t to√°n cho ${name}?`)) return;
      const sessions = await getDocs(collection(db, "sessions"));
      for (const s of sessions.docs) {
        const fees = await getDocs(collection(db, "sessions", s.id, "fees"));
        for (const f of fees.docs) {
          if (f.data().ten === name && !f.data().isThanhToan) {
            await updateDoc(doc(db, "sessions", s.id, "fees", f.id), { isThanhToan: true });
          }
        }
      }
      loadData();
    };

    /* ------------------ Modal L·ªãch s·ª≠ ------------------ */
    let isOpeningHistory = false;
    window.xemLichSu = async function (name) {
      const modal = document.getElementById("historyModal");
      const body = document.getElementById("historyBody");
      const totalBox = document.getElementById("historyTotal");

      // M·ªü modal ngay, show loading
      modal.style.display = "flex";
      body.innerHTML = `<tr><td colspan="3">‚è≥ ƒêang t·∫£i...</td></tr>`;
      totalBox.innerHTML = "";

      try {
        const sessionSnap = await getDocs(collection(db, "sessions"));
        const feePromises = sessionSnap.docs.map(async sessionDoc => {
          const feesSnap = await getDocs(collection(db, "sessions", sessionDoc.id, "fees"));
          return { session: sessionDoc.data(), fees: feesSnap.docs };
        });

        const allSessions = await Promise.all(feePromises);

        let total = 0;
        let rows = "";

        allSessions.forEach(({ session, fees }) => {
          fees.forEach(f => {
            const d = f.data();
            if (d.ten === name && !d.isThanhToan) {
              total += Number(d.tongtien);
              rows += `
            <tr>
              <td>${session.ghichu || ""}</td>
              <td>${session.ngay ? formatDateDDMMYYYY(session.ngay) : ""}</td>
              <td>${formatVND(d.tongtien)}</td>
            </tr>`;
            }
          });
        });

        if (rows === "") {
          body.innerHTML = `<tr><td colspan="3">‚úî Kh√¥ng c√≤n kho·∫£n n√†o ch∆∞a thanh to√°n.</td></tr>`;
        } else {
          body.innerHTML = rows;
          totalBox.innerHTML = `
        <tr style="font-weight:bold;background:#eef7ff">
          <td colspan="2">T·ªïng</td>
          <td>${formatVND(total)}</td>
        </tr>`;
        }
      } catch (err) {
        console.error(err);
        body.innerHTML = `<tr><td colspan="3">‚ùå L·ªói t·∫£i d·ªØ li·ªáu!</td></tr>`;
      }
    };

    window.closeHistory = () => {
      document.getElementById("historyModal").style.display = "none";
    };

    /* ------------------ LOGIN ------------------ */
    window.login = () => signInWithPopup(auth, provider).catch(e => alert(e.message));
    window.logout = () => signOut(auth);

    onAuthStateChanged(auth, user => {
      currentUser = user || null;
      document.getElementById("user-info").textContent = user ? `üëã ${user.displayName}` : "";
      document.getElementById("login-btn").classList.toggle("d-none", Boolean(user));
      document.getElementById("logout-btn").classList.toggle("d-none", !user);
      document.getElementById("admin-section").classList.toggle("d-none", !user || user.uid !== ADMIN_UID);
      loadData();
    });

    function formatDateDDMMYYYY(dateStr) {
      const d = new Date(dateStr);
      const day = String(d.getDate()).padStart(2, '0');     // 2 ch·ªØ s·ªë cho ng√†y
      const month = String(d.getMonth() + 1).padStart(2, '0'); // 2 ch·ªØ s·ªë cho th√°ng
      const year = d.getFullYear();
      return `${day}/${month}/${year}`;
    }
  </script>

  <!-- MODAL L·ªãch s·ª≠ -->
  <div id="historyModal" class="modal">
    <div class="modal-content">
      <h4>L·ªãch s·ª≠ ch∆∞a thanh to√°n</h4>
      <table class="table table-sm table-bordered mt-2">
        <thead>
          <tr>
            <th>Bu·ªïi</th>
            <th>Ng√†y</th>
            <th>S·ªë ti·ªÅn</th>
          </tr>
        </thead>
        <tbody id="historyBody"></tbody>
        <tfoot id="historyTotal"></tfoot>
      </table>
      <div class="text-end mt-2">
        <button class="btn btn-secondary btn-sm" onclick="closeHistory()">ƒê√≥ng</button>
      </div>
    </div>
  </div>

</body>

</html>